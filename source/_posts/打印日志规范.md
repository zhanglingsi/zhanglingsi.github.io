---
title: 打印日志规范
categories: 编程
copyright: true
---

# 打印日志规范

## Framework
**Slf4j + Logback**

## Pattern
格式：relative|time|ip|level|thread|packagename.classname|linenumber|msg

 1. relative：从程序启动到写入日志所耗费的时间。  
 2. time：当前时间，如：2014-07-23 16:27:04.547。
 3. ip：本机ip。
 4. level：日志级别。  
 5. thread：当前线程名称。 
 6. packagename.classname：java包名.类名。 
 7. linenumber：行数。  
 8. msg：日志详细信息。

<!-- more -->
## Msg
为了更好的管理和分析日志，所以对字段命名名进行统一，格式为json，字段名类型分为3 类。
 - A类：必填，字段名和顺序必须一致。
 - B类：选填，字段名必须一致，顺序随意。 
 - C类：选填，字段名和顺序都没有要求。

### A类
A类中只有一个字段：TrackingID。该id主要是为了分析一个请求在各个平台运行的整体情况，通过这个id关联起来。
TrackingID由以下扩展的巴科斯范式（ABNF模板）定义
```bash
trackingid = sendertype uuid *nvpair *sequence
sendertype = 1*ALPHA
uuid = "_" 8HEXDIG "-" 4HEXDIG "-" 4HEXDIG "-" 4HEXDIG "-" 12HEXDIG
nvpair = "_" name ":" value sequence = "_" 1*DIGIT
name = 1*ALPHA value = 1*ALPHA
```

#### Example
CIF_550e8400-e29b-41d4-a716-446655440000
GETWAY_550e8400-e29b-41d4-a716-446655440000_0
FONT_550e8400-e29b-41d4-a716-446655440000_1_1_3
MAX_550e8400-e29b-41d4-a716-446655440000_CSS1:1234
SER_550e8400-e29b-41d4-a716-446655440000_CSS1:1234_0_1
PRE_550e8400-e29b-41d4-a716-446655440000_CSS1:1234_AUDT:5678
CIF_550e8400-e29b-41d4-a716-446655440000_CSS1:1234_AUDT:5678_1_2

#### Illustration

 1. TrackingID中的sendertype必须唯一标识请求直接发起方，可以使⽤用系统名称。
 2. TrackingID中的uuid必须是标准的UUID 16进制8-4-4-4-12字符串。
 3.	如果有nvpair, 必须填充1...n个nvpair, nvpair的语义由service自由决定. (因使用"_"作为TrackingID各个component的分隔符, nvpair中不允许key或value中出现"_")。
 4.	下游service必须识别上游service的请求中带的TrackingID. 在下游service代表上游service继续请求其他service时,必须构造新的TrackingID, 其中uuid,nvpair和sequence 从上游service请求所带的TrackingID抽取,sendertype替换为下游service的标识,下游service可以添加新的nvair和sequence, 若添加了sequence,其值须反映由下游service 为响应上游service请求而发出的调用的次数.(如果service A调用service B, 我们称 service A为上游service, service B为下游service)。

#### 知识点补充：
ABNF 基本扩充要点（部分）：
ABNF的基本语法： name = elements crlf
用字符映射的ASCII码表示一个字符，格式为 %TYPE ，其中TYPE为进制（b/d/x三种）， b for binary（二进制），d for decimal（十进制），x for hexadecimal（十六进制）。如 %d13 和 %x0D 都代表 CR。
用句号（.）相连，表示一串连续的字符，如  %d13.10 代表CRLF（即%d13和%d10相连接），再如 %x44.6f.6d.61.69.6e.3a 1*FWS 代表"Domain: "这一个字符串（注意最后还有一个空格）。

ABNF的核心规则：
 - ALPHA = %x41-5A / %x61-7A    ; A-Z / a-z，即 大写和小写 ASCII 字母(A-Z, a-z)
 - BIT             =  "0" / "1" ; 即二进制字符
 - DQUOTE          =  %x22 ; " (Double Quote)，即 双引号
 - VCHAR           =  %x21-7E ; visible (printing) characters，即 可见字符
 - CHAR            =  %x01-7F ; any 7-bit US-ASCII character, excluding NUL，7位
 - OCTET           =  %x00-FF ; 8 bits of data，8位
 - CTL             =  %x00-1F / %x7F ; controls，即 控制字符
 - CR              =  %x0D ; carriage return，即  回车
 - LF              =  %x0A ; linefeed，即 换行
 - CRLF            =  CR LF ; Internet standard newline，即 互联网标准换行
 - DIGIT           =  %x30-39 ; 0-9
 - HEXDIG          =  DIGIT / "A" / "B" / "C" / "D" / "E" / "F" ;十六进制数字 (0-9, A-F, a-f)
 - SP              =  %x20 ; 即 空行
 - HTAB            =  %x09 ; horizontal tab，即 横向制表符（Tab）
 - WSP             =  SP / HTAB ; white space，即 空格或横向制表符
 - LWSP            =  *(WSP / CRLF WSP) ; 即 直线空白（晚于换行）

```bash
下面是JAVA语言中For语句的定义：
FOR_STATEMENT ::= "for" "(" ( variable_declaration | ( expression ";" ) | ";" ) [ expression ] ";" [ expression ] ")" statement
```
### B类
B类字段主要包含一些经常使用的和比较关键的信息，以@符号为前缀

 1. @marker 日志标识，可以理解为该条日志的业务说明，比如查询绑卡信息，订单入库结果等。
204|2014-07-27 14:47:23,443|192.168.2.104|INFO|main|c.e.t.j.LogTest|20| {"TrackingID":"TRADEENGINE_550e8400-e29b-41d4-a716-446655440000","marker":"测试⽇志","otorder":"2014072710234294234"} 

 2. @ex 简单异常信息，当有异常抛出时使用
204|2014-07-27 14:47:23,443|192.168.2.104|INFO|main|c.e.t.j.LogTest|20|
{"TrackingID":"TRADEENGINE_550e8400-e29b-41d4-a716-446655440000","marker":"测试⽇志","ex":"java.lang.RuntimeException:null"}

 3. @mobacc 手机号
204|2014-07-27 14:47:23,443|192.168.2.104|INFO|main|c.e.t.j.LogTest|20|
{"TrackingID":"TRADEENGINE_550e8400-e29b-41d4-a716-446655440000","marker":"测试⽇志","otorder":"2014072710234294234","mobacc":"18930572293"}

这里不在一一列举，根据业务需求，项目组内部规定字段。

### 配置 Conf
在logback的appender中配置
```bash
<encoder>
    <pattern>%relative|%date|%X{ip}|%level|%thread|%logger{0}|%L|%m%n</pattern>
</encoder>
```
#### Note：ip需要先在程序里设置 
```bash
MDC.put("ip", InetAddress.getLocalHost().getHostAddress());
```

### Check List 
 - 对于所有接口、方法或函数的入口或返回点，分别打印日志进行标识，并输出入口或返回点的所有参数。
 - 为便于关联、定位分析日志，涉及参数或数据信息的日志输出行应有唯一标识号，标识号可以是订单号或各类流水号等。
 - 在方法内的逻辑判断点，如if/else等条件判断点，必须打印日志进行标识，并在同一行内，输出所有参数
 - 多线程应用应将同一个输出点的输出内容打印在同一行，便于后续查证。
 - 如果捕获异常，要在日志输出中，将具体异常内容和相关参数一起打印出来。
 - 在调用外部接口时，需在发起接口调用前和接口返回后，分别输出日志，并输出接口调用前和返回后的相关参数。
 - 对外提供的服务或接口，应在被调用后，输出调用方的IP地址。
 - 管理类应用如综管台、业管系统等，需将登录用户名在日志中进行输出。
 - 涉及银行卡号、密码、身份证号等敏感信息的不允许在日志中进行输出，如确因业务或
 - 查证需要必须输出到日志中的，需报研发中心安全管理员审核批准，并对敏感信息的中间部分数据位用类似***的掩码输出。
 - 日志中输出的参数或数据之间，使用“|”符号作为分隔符。
 - 对于日志的打印，任何情况下都不允许日志错误导致业务失败。
 - 对于异常堆栈的输出，必须以log.XXX (“msg”,e)的形式输出，禁止log.XXX (“msg”+e)的错误形式。
 - 对于由于系统原因造成业务处理失败的事件，需要记录错误日志。非系统原因的业务处理失败，不应该记错误日志（推荐使用warn级别），避免错误日志过大，影响紧急情况下的故障分析与诊断。
 - 生产代码禁止以System及Throwable.printStackTrace的方式输出日志信息，必须用Logger替代。


